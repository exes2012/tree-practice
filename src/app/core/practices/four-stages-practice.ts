import { PracticeContext, PracticeConfig } from '../models/practice-engine.types';
import { step, rating, input, practiceRating } from './practice-blocks';

/**
 * Практика "4 стадии прямого света" на движке runner
 */
export async function* fourStagesPractice(context: PracticeContext) {
  // Подготовка
  yield step(
    'preparation',
    'Подготовка: Настройка на Свет',
    'Прежде всего, чтобы изучать Каббалу, человек должен ощущать высший свет. Свет — это не просто слово, это наслаждение от свойства отдачи. Чтобы его ощущать, нужна особая настройка.'
  );

  // СТАДИЯ 0: КЕТЕР
  yield step(
    'keter-intention',
    'Стадия 0: Кетер (כתר) - Создайте намерение (расчёт)',
    'Спросите себя, как вы сейчас используете свою природу. Вероятно, вы думаете о себе. Нужно это изменить. Выберите кого-то, кто вам действительно дорог — любимого человека, ребёнка, друга.'
  );

  yield step(
    'keter-goal',
    'Стадия 0: Кетер (כתר) - Сформируйте цель',
    'Ваша цель — насладить этого человека. Подумайте о том, как сделать ему что-то приятное, вызвать в нём наслаждение (кайф). Пока вы думаете об этом, вы используете своё желание (свою природу) для того, чтобы насладить кого-то вне себя. Это и есть правильное намерение.'
  );

  yield step(
    'keter-aspiration',
    'Стадия 0: Кетер (כתר) - Добавьте стремление',
    'Когда намерение создано, начните добавлять стремление — внутреннюю силу, которую вы прикладываете для достижения цели.'
  );

  yield step(
    'keter-direct-outward',
    'Стадия 0: Кетер (כתר) - Направьте стремление вовне',
    'Удерживая в мыслях образ дорогого вам человека и желание его насладить, начните прикладывать внутреннее усилие, направленное вовне, к нему. Делайте это потихонечку, но постоянно.'
  );

  yield step(
    'keter-light-response',
    'Стадия 0: Кетер (כתר) - Ощутите ответ света',
    'Продолжая так стремиться, вы почувствуете, как к вам приходит свет — наслаждение от свойства отдачи.'
  );

  yield step(
    'keter-strengthen',
    'Стадия 0: Кетер (כתר) - Усильте стремление',
    'Чтобы ощутить свет ярче, сделайте небольшой рывок стремления вовне, чуть сильнее по отношению к тому, о ком думаете. Вы сразу почувствуете, как свет отвечает и приходит более ярко. Свет конкретно реагирует на ваше стремление.'
  );

  yield step(
    'keter-summary',
    'Итог стадии Кэтер',
    'Это стадия Кэтер: вы бесконечно стремитесь вне себя, в отдачу, и свет бесконечности вам отвечает.'
  );

  // СТАДИЯ 1: ХОХМА
  yield step(
    'hochma-change-vector',
    'Стадия 1: Хохма (חכמה) - Измените вектор стремления',
    'Теперь, когда вы настроились на свет и ощущаете его, нужно поменять вектор работы. Силу, которую вы прикладывали для стремления вовне (в отдачу), начните использовать для притяжения к себе. Цепляясь за свет, который вы вызвали, начните приглашать его внутрь.'
  );

  yield step(
    'hochma-receive-moderately',
    'Стадия 1: Хохма (חכמה) - Получайте без требований',
    'Притягивайте ровно столько света, сколько приходит. Не требуйте большего. «Вот что приходит, то и хорошо». Важно, чтобы стремление было бесконечным, но аккуратным. Вы ощутите, как свет теперь наполняет вас изнутри.'
  );

  yield step(
    'hochma-reveal-creator',
    'Стадия 1: Хохма (חכמה) - Раскройте отношение творца',
    'Когда свет наполняет вас, смотрите не просто на кайф, а на отношение, с которым этот свет приходит. Сделайте небольшой рывок в получении, притяните чуть сильнее. Вы увидите, что свет сразу же реагирует, приходит больше. Он живой. Вы раскрываете, что за этим светом есть добрый источник, который хочет вас насладить и ничего не требует взамен, кроме вашего стремления получать.'
  );

  yield step(
    'hochma-summary',
    'Итог стадии Хохма',
    'Это стадия Хохма: вы притягиваете свет и ощущаете его внутри себя, раскрывая за наслаждением живого, любящего Творца.'
  );

  // СТАДИЯ 2: БИНА
  yield step(
    'bina-gratitude',
    'Стадия 2: Бина (בינה) - Ощутите благодарность',
    'Когда в стадии Хохма вы раскрываете живого Творца, который на вас реагирует, в вас рождается огромное чувство благодарности. Эта благодарность настолько сильна, что вам хочется сказать «спасибо» этому источнику. Желание меняется: вы больше не хотите просто получать, вы хотите насладить Его.'
  );

  yield step(
    'bina-aspire-giving',
    'Стадия 2: Бина (בינה) - Снова стремитесь в отдачу',
    'Теперь вы используете стремление опять вне себя, но уже не просто к образу человека, а к ощущаемому вами Источнику света. Вы хотите, чтобы свет, который вас наполняет, вернулся к Нему и ощущался в Нём.'
  );

  yield step(
    'bina-enjoy-giving',
    'Стадия 2: Бина (בינה) - Наслаждайтесь отдачей',
    'Это стремление вызывает в вас такой кайф, такую благодарность «до соплей, до слёз», что вы хотите навсегда остаться в этом состоянии — в отдаче. Вы начинаете как бы выталкивать из себя весь свет, возвращая его Творцу, и наслаждаетесь от этого не меньше, чем от получения.'
  );

  yield step(
    'bina-paradox',
    'Стадия 2: Бина (בינה) - Осознайте парадокс',
    'Чем сильнее вы стремитесь в отдачу и выталкиваете свет, тем сильнее он давит на вас сверху вниз, на получение. Творец показывает вам: «Хочешь мне отдавать? Так свет, который Я заготовил для тебя, должен находиться внутри тебя, а ты его выкидываешь».'
  );

  yield step(
    'bina-summary',
    'Итог стадии Бина',
    'Это стадия Бина: вы стремитесь в чистой отдаче из благодарности к Творцу и через Его ответ понимаете, что истинная отдача — это получать то, что Он хочет вам дать.'
  );

  // СТАДИЯ 3: ЗЕИР АНПИН
  yield step(
    'za-accept-for-creator',
    'Стадия 3: ЗА (זעיר אנפין) - Примите свет «ради него»',
    'Это стадия, где соединяются Хохма и Бина. Вы остаётесь в своей благодарности (Бина), но принимаете желание Творца (получение). Находясь в Бине и ощущая, как свет давит на получение, вы принимаете решение: «Ладно, раз Ты так хочешь, ради Тебя я буду получать».'
  );

  yield step(
    'za-combine-actions',
    'Стадия 3: ЗА (זעיר אנפין) - Совместите два действия',
    'Начните выполнять два действия одновременно. Чуть-чуть притягивайте свет к себе, как в Хохме, но делайте это с намерением, чтобы отдавать, как в Бине. Сначала можно делать по очереди: притянул — перевернул в отдачу. Затем старайтесь делать это вместе.'
  );

  yield step(
    'za-gain-control',
    'Стадия 3: ЗА (זעיר אנפין) - Обретите контроль',
    'Вы ощутите, как наслаждаетесь сразу от двух природ: и от получения, и от отдачи. И главное — от того, что вы теперь контролируете эти состояния, а не бегаете за ними. Вы бесконечно получаете и бесконечно отдаёте одновременно.'
  );

  yield step(
    'za-summary',
    'Итог стадии ЗА',
    'Это стадия ЗА, или получение ради отдачи. Вы осознаёте, что значит по-настоящему отдавать Творцу.'
  );

  // СТАДИЯ 4: МАЛХУТ
  yield step(
    'malchut-tzimtzum',
    'Стадия 4: Малхут (מלכות) - Сокращение (цимцум)',
    'После освоения этих стадий рождается настоящая Малхут — осознанное желание получить весь свет, который Творец заготовил, но сделать это исправленным образом. Вы понимаете, что просто получать всем своим эгоизмом нельзя — свет пропадёт, как оргазм, который исчезает в момент получения. Поэтому вы делаете сокращение: вы стремитесь получить свет, притягиваете его со всей силой, но сдерживаете себя от получения. Вы удерживаете весь кайф как бы перед собой, не впуская внутрь.'
  );

  yield step(
    'malchut-screen',
    'Стадия 4: Малхут (מלכות) - Экран (масах) и удар (зивуг де-акаа)',
    'Удерживать свет в сокращении тяжело. Чтобы обрести лёгкий контроль, нужен экран. Когда вы притягиваете свет и чувствуете, как он давит на ваше сокращение, сделайте этим сокращением резкий удар в свет — противоположным стремлением, жёстко вовне. Но во время удара не давайте свету убежать, сразу возвращайте его на то же место перед собой. После такого удара вы почувствуете, что обрели полный и лёгкий контроль над светом.'
  );

  // Заключение
  yield step(
    'conclusion',
    'Итог практики',
    'Это основа, ваши пять органов чувств, с которыми начинается настоящее знакомство с наукой Каббала. Каждое слово — Кетер, Хохма, Бина, Зеир Анпин, Малхут — это не информация, а конкретное внутреннее действие, которое вы должны выполнять.'
  );

  // Финальная оценка ПРАКТИКИ
  yield practiceRating();

  // Возвращаем результат
  return {
    rating: context.get('practice-final-rating'),
  };
}

// Конфигурация практики
export const fourStagesPracticeConfig: PracticeConfig = {
  id: 'four-stages',
  title: '4 стадии прямого света',
  description:
    'Эта практика - основа каббалистической медитации. Она позволяет пройти четыре стадии взаимодействия с высшим светом, от получения до полной отдачи.',

  hasStartScreen: true,
  startScreenContent: {
    title: '4 стадии прямого света',
    description:
      'Эта практика - основа каббалистической медитации. Она позволяет пройти четыре стадии взаимодействия с высшим светом, от получения до полной отдачи.',
    duration: '30 мин',
    level: 'Средний',
  },

  practiceFunction: fourStagesPractice,

  onFinish: async (context, result) => {
    // Save practice run and optional insight to IndexedDB
    const { JournalService } = await import('../services/journal.service');
    const { dateToLocalDateKey } = await import('../services/db.service');

    const completedAt = new Date().toISOString();
    const dateKey = dateToLocalDateKey(new Date());

    const journal = new JournalService();
    const practiceRunId = await journal.savePracticeRun({
      practiceId: 'four-stages',
      title: '4 стадии прямого света',
      route: '/practices/runner/four-stages',
      completedAt,
      dateKey,
      rating: context.get('practice-final-rating') as number | undefined,
      duration: result.duration as number | undefined,
    });

    console.log('Practice completed with result:', result);
  },
};

import { PracticeContext, PracticeConfig } from '../models/practice-engine.types';
import { step, rating, input, practiceRating } from './practice-blocks';

/**
 * Практика "Настройка на свет" (Кетер) на движке runner
 */
export async function* keterTuningPractice(context: PracticeContext) {
  // Шаг 1.1: Осознание природы
  yield step(
    'realize-nature',
    'Шаг 1.1: Осознайте свою природу',
    'Поймите, что ваше естественное состояние — думать о себе и своих желаниях. Для практики это нужно сознательно изменить.'
  );

  // Шаг 1.2: Выбор объекта отдачи
  yield step(
    'choose-object',
    'Шаг 1.2: Выберите объект отдачи',
    'Мысленно выберите кого-то, кто вам по-настоящему дорог. Это должен быть конкретный человек (или существо), к которому вы испытываете тёплые чувства. Абстрактные идеи («всё человечество») на начальном этапе работают хуже.'
  );

  // Шаг 1.3: Концентрация на желании насладить
  yield step(
    'focus-on-delight',
    'Шаг 1.3: Сконцентрируйтесь на желании насладить',
    'Это ключевой момент. Ваша задача — не просто думать об этом человеке, а активно захотеть насладить его. Подумайте: «Что я могу сделать, чтобы вызвать в нём радость, кайф? Как я могу его наполнить?» Проживите это желание. Само это обдумывание, где вы свою природу (желание) используете для блага другого, и есть создание правильного намерения.'
  );

  // Шаг 2.1: Добавление стремления
  yield step(
    'add-aspiration',
    'Шаг 2.1: Начните добавлять Стремление',
    'Удерживая мысль о наслаждении другого, начните прикладывать внутреннее усилие, направленное от себя к этому человеку. «Потихонечку добавляй стремление, потихонечку, но в постоянстве». Это не разовый толчок, а начало непрерывного, аккуратного потока энергии вовне.'
  );

  // Шаг 2.2: Ощущение первого ответа света
  yield step(
    'feel-light-response',
    'Шаг 2.2: Ощутите первый ответ Света',
    'Продолжая это постоянное стремление в отдачу, вы начнёте ощущать тонкое, приятное чувство — это и есть «свет», наслаждение от самого свойства отдачи, которое к вам приходит.'
  );

  // Шаг 2.3: Усиление через рывок
  yield step(
    'strengthen-through-surge',
    'Шаг 2.3: Усильте ощущение через «Рывок»',
    'Это главный технический приём для углубления стадии Кэтер. Когда вы чувствуете свет, сделайте осознанный, но аккуратный рывок стремления — короткое, чуть более интенсивное усилие в том же направлении, вовне. Скажите себе мысленно: «Насладись сильнее».'
  );

  // Шаг 2.4: Наблюдение за реакцией
  yield step(
    'observe-reaction',
    'Шаг 2.4: Наблюдайте за реакцией',
    'Вы увидите, что в ответ на этот рывок свет мгновенно приходит ярче. Это прямое доказательство того, что Свет конкретно реагирует на ваше стремление. Повторите несколько раз: постоянное стремление -> аккуратный рывок -> усиление света. Так вы учитесь управлять этим состоянием.'
  );

  // Финальная оценка ПРАКТИКИ
  yield practiceRating();

  // Возвращаем результат
  return {
    rating: context.get('practice-final-rating'),
  };
}

// Конфигурация практики
export const keterTuningPracticeConfig: PracticeConfig = {
  id: 'keter-tuning',
  title: 'Настройка на свет',
  description:
    'Цель практики: Ощутить «Высший свет», который определяется как наслаждение от свойства отдачи. Стадия Кетер — это корень, первоначальная настройка, без которой остальные стадии невозможны.',

  hasStartScreen: true,
  startScreenContent: {
    title: 'Настройка на свет',
    description:
      'Цель практики: Ощутить «Высший свет», который определяется как наслаждение от свойства отдачи. Стадия Кетер — это корень, первоначальная настройка, без которой остальные стадии невозможны. Это чистое, бесконечное стремление вовне, не ради получения чего-либо взамен, а ради самого акта отдачи.',
    duration: '15 мин',
    level: 'Начальный',
  },

  practiceFunction: keterTuningPractice,

  onFinish: async (context, result) => {
    // Save practice run and optional insight to IndexedDB
    const { JournalService } = await import('../services/journal.service');
    const { dateToLocalDateKey } = await import('../services/db.service');

    const completedAt = new Date().toISOString();
    const dateKey = dateToLocalDateKey(new Date());

    const journal = new JournalService();
    const practiceRunId = await journal.savePracticeRun({
      practiceId: 'keter-tuning',
      title: 'Настройка на свет',
      route: '/practices/runner/keter-tuning',
      completedAt,
      dateKey,
      rating: context.get('practice-final-rating') as number | undefined,
      duration: result.duration as number | undefined,
    });

    console.log('Practice completed with result:', result);
  },
};

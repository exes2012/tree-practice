import { PracticeContext, PracticeConfig } from '../models/practice-engine.types';
import { step, rating, hebrewStep, practiceRating } from './practice-blocks';

/**
 * –ü—Ä–∞–∫—Ç–∏–∫–∞ "–ü–ª–∞–º—è —Å–≤–µ—á–∏" (–ò—Ö—É–¥) –Ω–∞ –¥–≤–∏–∂–∫–µ runner
 */
export async function* candleFlameYichudPractice(context: PracticeContext) {
  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞
  yield step(
    'preparation',
    '–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞',
    '–û–±—Ä–∞—Ç–∏–º—Å—è –∫ –º–µ–¥–∏—Ç–∞—Ü–∏–∏ –Ω–∞–¥ —Å–ª–æ–≤–∞–º–∏ —Ü–∞—Ä—è –®–ª–æ–º–æ –≤ –ö–Ω–∏–≥–µ –ú–∏—à–ª–µ–π (–ü—Ä–∏—Ç—á): ¬´–î—É—à–∞ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äì —Å–≤–µ—á–∞ –ë–æ–≥–∞¬ª.'
  );

  // –ü–ª–∞–º—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏
  yield step(
    'flame-movement',
    '–ü–ª–∞–º—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏',
    '–ü–ª–∞–º—è —Å–≤–µ—á–∏ –≤—Å–µ –≤—Ä–µ–º—è –∂–∏–≤–æ –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –¥–≤–∏–∂–µ–Ω–∏–∏, –∫–∞—á–∞—è—Å—å –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã. –ò–Ω–æ–≥–¥–∞ —ç—Ç–∏ –∫–æ–ª–µ–±–∞–Ω–∏—è –æ—á–µ–Ω—å —Å–∏–ª—å–Ω—ã, –∏–Ω–æ–≥–¥–∞ ‚Äì –ø–æ—á—Ç–∏ –Ω–µ–∑–∞–º–µ—Ç–Ω—ã.'
  );

  // –î—É—à–∞ –∫–∞–∫ –ø–ª–∞–º—è
  yield step(
    'soul-as-flame',
    '–î—É—à–∞ –∫–∞–∫ –ø–ª–∞–º—è',
    '–¢–∞–∫–∏–µ –∂–µ –¥–≤–∏–∂–µ–Ω–∏—è —Å–æ–≤–µ—Ä—à–∞–µ—Ç –∂–∏–≤–∞—è —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∞—è –¥—É—à–∞, —Å–≤–µ—á–∞ –ë–æ–≥–∞: –æ–Ω–∞ –≤—Å–µ –≤—Ä–µ–º—è –∫–æ–ª–µ–±–ª–µ—Ç—Å—è –≤ —Ä–∞–∑–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã, —Å—Ç—Ä–µ–º—è—Å—å –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–≤–æ–µ–º—É –∏—Å—Ç–æ—á–Ω–∏–∫—É, –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º—É –°–≤–µ—Ç—É –ë–æ–≥–∞.'
  );

  // –¢–µ–ª–æ –∏ –¥—É—à–∞
  yield step(
    'body-and-soul',
    '–¢–µ–ª–æ –∏ –¥—É—à–∞',
    '–í —ç—Ç–æ–º —Ñ–∏–∑–∏—á–µ—Å–∫–æ–º –º–∏—Ä–µ –¥—É—à–∞ –æ–±–ª–µ—á–µ–Ω–∞ –≤ —Ç–µ–ª–æ, –ø–æ—ç—Ç–æ–º—É –∫–æ–ª–µ–±–∞–Ω–∏—è –¥—É—à–∏ –ø—Ä–∏–≤–æ–¥—è—Ç –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º –∫–æ–ª–µ–±–∞–Ω–∏—è–º —Ç–µ–ª–∞.'
  );

  // –†–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥ —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º
  yield step(
    'forward-backward',
    '–†–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥',
    '–î–∞–≤–∞–π—Ç–µ –≤—Å—Ç–∞–Ω–µ–º –ø—Ä—è–º–æ –∏ –±—É–¥–µ–º —Ä–∞—Å–∫–∞—á–∏–≤–∞—Ç—å—Å—è. –°–Ω–∞—á–∞–ª–∞ –±—É–¥–µ–º —Ä–∞—Å–∫–∞—á–∏–≤–∞—Ç—å—Å—è –≤–ø–µ—Ä–µ–¥‚Äì–Ω–∞–∑–∞–¥. –¢–∞–∫–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—Ä–∞–∂–∞–µ—Ç –º—É–∂—Å–∫–æ–π –∞—Å–ø–µ–∫—Ç –Ω–∞—à–µ–π –¥—É—à–∏.<br><br><strong>üßò‚Äç‚ôÇÔ∏è –í—Å—Ç–∞–Ω—å—Ç–µ –∏ –º—è–≥–∫–æ —Ä–∞—Å–∫–∞—á–∏–≤–∞–π—Ç–µ—Å—å –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥</strong>'
  );

  // –†–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–ø—Ä–∞–≤–æ-–≤–ª–µ–≤–æ —Å –¥–≤–∏–∂–µ–Ω–∏–µ–º
  yield step(
    'right-left',
    '–†–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–ø—Ä–∞–≤–æ-–≤–ª–µ–≤–æ',
    '–¢–µ–ø–µ—Ä—å –±—É–¥–µ–º —Ä–∞—Å–∫–∞—á–∏–≤–∞—Ç—å—Å—è –≤–ø—Ä–∞–≤–æ‚Äì–≤–ª–µ–≤–æ. –†–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ —ç—Ç–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç—Ä–∞–∂–∞–µ—Ç –∂–µ–Ω—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç –Ω–∞—à–µ–π –¥—É—à–∏. –ï—Å–ª–∏ –≤—ã —Ä–∞—Å–∫–∞—á–∏–≤–∞–µ—Ç–µ—Å—å —Å—Ç–æ—è, —Ç–µ–ª–æ –¥–æ–ª–∂–Ω–æ —Å–≥–∏–±–∞—Ç—å—Å—è –≤ –ø–æ—è—Å–Ω–∏—Ü–µ.<br><br><strong>üßò‚Äç‚ôÄÔ∏è –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ —Ä–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–ø—Ä–∞–≤–æ-–≤–ª–µ–≤–æ</strong>'
  );

  // –¢–æ—Ä–∞ –∏ –º–æ–ª–∏—Ç–≤–∞
  yield step(
    'torah-prayer',
    '–¢–æ—Ä–∞ –∏ –º–æ–ª–∏—Ç–≤–∞',
    '–ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–æ–ª–µ–±–∞—Ç–µ–ª—å–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è –¥—É—à–∏, –ø–æ–¥–æ–±–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è–º –ø–ª–∞–º–µ–Ω–∏ —Å–≤–µ—á–∏, –Ω–∞–∏–±–æ–ª–µ–µ —è—Ä–∫–æ –ø—Ä–æ—è–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –∏–∑—É—á–µ–Ω–∏–∏ —Å–≤—è—Ç–æ–π –¢–æ—Ä—ã –∏–ª–∏ –ø—Ä–∏ –º–æ–ª–∏—Ç–≤–µ –∏–∑ –≥–ª—É–±–∏–Ω—ã —Å–µ—Ä–¥—Ü–∞.'
  );

  // –°—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –°–≤–µ—Ç—É - —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –º–µ–¥–∏—Ç–∞—Ü–∏—è
  yield step(
    'striving-to-light',
    '–°—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –°–≤–µ—Ç—É',
    '–ò—Å–∫—Ä–∞ –ë-–≥–∞ –≤ –Ω–∞—Å, –ø–ª–∞–º—è –Ω–∞—à–µ–π –¥—É—à–∏, –≤—Å–µ–≥–¥–∞ —Å—Ç—Ä–µ–º–∏—Ç—Å—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ë-–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º—É –ë–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º—É –°–≤–µ—Ç—É –∏ —Å–ª–∏—Ç—å—Å—è —Å –ù–∏–º. –ü—É—Å—Ç—å —ç—Ç–∞ –∏—Å–∫—Ä–∞ –Ω–µ–ø—Ä–µ—Å—Ç–∞–Ω–Ω–æ —Ä–∞–∑–≥–æ—Ä–∞–µ—Ç—Å—è —è—Ä—á–µ –∏ —è—Ä—á–µ. –ö–∞–∫ –±—ã –Ω–∏ –º—ã –∫–æ–ª–µ–±–∞–ª–∏—Å—å, –ª—é–±–æ–µ –Ω–∞—à–µ –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –∫ –¢–µ–±–µ.'
  );

  // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ü–†–ê–ö–¢–ò–ö–ò
  yield practiceRating();

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  return {
    rating: context.get('practice-final-rating'),
  };
}

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∞–∫—Ç–∏–∫–∏
export const candleFlameYichudPracticeConfig: PracticeConfig = {
  id: 'candle-flame-yichud',
  title: '–ü–ª–∞–º—è —Å–≤–µ—á–∏',
  description:
    '¬´–î—É—à–∞ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äì —Å–≤–µ—á–∞ –ë–æ–≥–∞¬ª. –ú—ã –±—É–¥–µ–º –º–µ–¥–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–ª–∞–º–µ–Ω–∏ —Å–≤–µ—á–∏ –∫–∞–∫ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π –Ω–∞—à–µ–π –¥—É—à–∏. –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è - —Ä–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥ (–º—É–∂—Å–∫–æ–π –∞—Å–ø–µ–∫—Ç) –∏ –≤–ø—Ä–∞–≤–æ-–≤–ª–µ–≤–æ (–∂–µ–Ω—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç).',

  hasStartScreen: true,
  startScreenContent: {
    title: '–ü–ª–∞–º—è —Å–≤–µ—á–∏',
    description:
      '¬´–î—É—à–∞ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äì —Å–≤–µ—á–∞ –ë–æ–≥–∞¬ª. –ú—ã –±—É–¥–µ–º –º–µ–¥–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–ª–∞–º–µ–Ω–∏ —Å–≤–µ—á–∏ –∫–∞–∫ –æ—Ç—Ä–∞–∂–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π –Ω–∞—à–µ–π –¥—É—à–∏. –ü—Ä–∞–∫—Ç–∏–∫–∞ –≤–∫–ª—é—á–∞–µ—Ç —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è - —Ä–∞—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–ø–µ—Ä–µ–¥-–Ω–∞–∑–∞–¥ (–º—É–∂—Å–∫–æ–π –∞—Å–ø–µ–∫—Ç) –∏ –≤–ø—Ä–∞–≤–æ-–≤–ª–µ–≤–æ (–∂–µ–Ω—Å–∫–∏–π –∞—Å–ø–µ–∫—Ç).',
    duration: '20 –º–∏–Ω',
    level: '–ù–∞—á–∞–ª—å–Ω—ã–π',
  },

  practiceFunction: candleFlameYichudPractice,

  onFinish: async (context, result) => {
    // Save practice run to IndexedDB
    const { JournalService } = await import('../services/journal.service');
    const { dateToLocalDateKey } = await import('../services/db.service');

    const completedAt = new Date().toISOString();
    const dateKey = dateToLocalDateKey(new Date());

    const journal = new JournalService();
    await journal.savePracticeRun({
      practiceId: 'candle-flame-yichud',
      title: '–ü–ª–∞–º—è —Å–≤–µ—á–∏',
      route: '/practices/runner/candle-flame-yichud',
      completedAt,
      dateKey,
      rating: context.get('practice-final-rating') as number | undefined,
      duration: result.duration as number | undefined,
    });

    console.log('Practice completed with result:', result);
  },
};

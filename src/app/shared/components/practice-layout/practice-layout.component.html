<!-- Practice Header -->
<div
  class="practice-header sticky top-0 z-10 border-b border-neutral-100 bg-white shadow-sm dark:border-neutral-700 dark:bg-neutral-800"
>
  <div class="container mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <!-- Back Button -->
      <button
        (click)="goHome()"
        class="flex h-10 w-10 items-center justify-center rounded-full bg-neutral-100 transition-colors hover:bg-neutral-200 dark:bg-neutral-700 dark:hover:bg-neutral-600"
      >
        <i class="material-icons text-neutral-500">home</i>
      </button>

      <!-- Practice Title -->
      <h1 *ngIf="practiceTitle" class="text-chart mx-4 flex-1 text-center text-lg font-semibold">
        {{ practiceTitle }}
      </h1>

      <!-- Voice Toggle Button -->
      <button
        (click)="toggleVoice()"
        class="flex h-10 w-10 items-center justify-center rounded-full bg-neutral-100 transition-colors hover:bg-neutral-200 dark:bg-neutral-700 dark:hover:bg-neutral-600"
      >
        <i class="material-icons text-neutral-500">{{
          isVoiceEnabled ? 'volume_up' : 'volume_off'
        }}</i>
      </button>
    </div>
  </div>
</div>

<!-- Practice Steps -->
<div class="container mx-auto bg-neutral-50 px-4 pb-24 pt-4 dark:bg-neutral-900">
  <div class="rounded-xl bg-white p-6 shadow-sm dark:bg-neutral-800">
    <!-- Step Content -->
    <div *ngIf="currentStep">
      <ng-container *ngIf="stepContent">
        <ng-container
          *ngTemplateOutlet="
            stepContent;
            context: {
              $implicit: currentStep,
              step: currentStep,
              currentStepIndex: currentStepIndex,
              index: currentStepIndex,
            }
          "
        ></ng-container>
      </ng-container>

      <!-- Fallback if no stepContent template -->
      <div *ngIf="!stepContent">
        <h2 *ngIf="currentStep.title" class="text-chart mb-2 text-xl font-semibold">
          {{ currentStep.title }}
        </h2>
        <p class="mb-6 text-neutral-500 dark:text-neutral-400" [innerHTML]="currentStep.instruction"></p>
      </div>

      <!-- Rating section for last step -->
      <div *ngIf="isLastStep() && isRatingStep()" class="mt-6">
        <div class="mb-6 text-center">
          <!-- Rating icon display -->
          <div class="mb-4">
            <i class="material-icons text-primary-500 text-5xl">{{ getRatingIcon() }}</i>
          </div>

          <!-- Rating slider -->
          <div class="mb-4">
            <input
              type="range"
              min="1"
              max="10"
              [(ngModel)]="userRating"
              class="range-slider h-2 w-full cursor-pointer appearance-none rounded-lg bg-neutral-200 dark:bg-neutral-700"
              (input)="onRatingChange($event)"
            />
          </div>

          <!-- Rating value display -->
          <div class="text-lg font-semibold text-neutral-700 dark:text-neutral-300">
            {{ userRating }} / 10
          </div>
        </div>
      </div>
    </div>

    <!-- Stage indicator -->
    <div *ngIf="currentStep && currentStep.stage" class="mb-3">
      <span
        class="inline-block rounded-md px-3 py-1 text-base font-medium"
        [ngClass]="currentStep.stageColor"
      >
        {{ currentStep.stage }}
      </span>
    </div>

    <!-- Repetition Toggle -->
    <div
      *ngIf="currentStep?.repeatablePhrase && currentStep?.showToggleRepetition !== false"
      class="mt-4 text-center"
    >
      <button
        (click)="toggleRepetition()"
        class="mx-auto flex h-10 w-10 items-center justify-center rounded-full bg-neutral-100 transition-colors hover:bg-neutral-200 dark:bg-neutral-800 dark:hover:bg-neutral-700"
      >
        <i class="material-icons text-neutral-500">{{
          isRepetitionActive ? 'volume_off' : 'volume_up'
        }}</i>
      </button>
      <p class="mt-2 text-sm text-neutral-500 dark:text-neutral-400">
        {{ isRepetitionActive ? 'Остановить повтор' : 'Повторять фразу' }}
      </p>
    </div>

    <!-- Timer Display -->
    <div
      *ngIf="showTimer && currentStepIndex < steps.length - 1"
      class="text-primary-500 my-4 text-center text-4xl font-bold"
    >
      <span *ngIf="currentStepIndex < mainPracticeStepIndex">{{
        stepTimer * 1000 | date: 'mm:ss'
      }}</span>
      <span *ngIf="currentStepIndex === mainPracticeStepIndex">{{
        practiceTimer * 1000 | date: 'mm:ss'
      }}</span>
    </div>

    <!-- Navigation Buttons -->
    <div class="mt-8 flex justify-between">
      <button
        (click)="currentStepIndex === 0 ? goBack() : previousStep()"
        class="rounded-lg bg-neutral-200 px-6 py-2 font-semibold text-neutral-700 transition-colors hover:bg-neutral-300"
      >
        {{ currentStepIndex === 0 ? 'Выход' : 'Назад' }}
      </button>

      <button
        *ngIf="currentStepIndex < steps.length - 1"
        (click)="nextStep()"
        class="bg-primary rounded-lg px-6 py-2 font-semibold text-white transition-colors hover:bg-primary-shade"
      >
        Далее
      </button>

      <button
        *ngIf="currentStepIndex === steps.length - 1"
        (click)="finishPracticeWithRating()"
        class="bg-primary rounded-lg px-6 py-2 font-semibold text-white transition-colors hover:bg-primary-shade"
      >
        Завершить
      </button>
    </div>
  </div>
</div>
<div class="diary-page surface flex h-full flex-col">
  <!-- Sticky Header like Notes -->
  <div
    class="sticky top-0 z-10 border-b border-subtle surface-elevated shadow-sm"
  >
    <div class="space-y-3 px-4 py-3">
      <!-- Title -->
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <button
            (click)="goToHome()"
            class="icon-btn-primary mr-3"
          >
            <i class="material-icons text-muted">arrow_back</i>
          </button>
          <div>
            <h1 class="text-primary text-lg font-semibold">Дневник</h1>
            <div *ngIf="totalDuration > 0" class="text-secondary text-xs">
              Всего практиковал: {{ formatDuration(totalDuration) }}
            </div>
          </div>
        </div>
        <!-- Date Navigation -->
        <div class="flex items-center space-x-2">
          <button
            (click)="prevDay()"
            class="icon-btn-primary"
          >
            <i class="material-icons text-primary">chevron_left</i>
          </button>
          <div class="px-2 text-center">
            <div class="text-primary text-sm font-semibold leading-5">
              {{ formatDate(dateKey) }}
            </div>
            <div class="text-secondary text-xs leading-4">
              {{ formatDay(dateKey) }}
            </div>
          </div>
          <button
            (click)="nextDay()"
            class="icon-btn-primary"
          >
            <i class="material-icons text-primary">chevron_right</i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="flex-1">
    <div class="space-y-6 p-4 pb-24">
      <!-- Timeline: mood + events -->
      <div class="surface-elevated rounded-xl p-0 shadow-sm">
        <div class="divide-y divide-subtle">
          <!-- Mood selector row (only today) -->
          <div class="px-6 py-4" *ngIf="isToday">
            <h2 class="text-primary mb-3 text-lg font-semibold">
              Как настроение?
            </h2>
            <div class="flex justify-center gap-2">
              <button
                *ngFor="let v of moodIconOptions"
                (click)="setMood(v)"
                [class.ring-2]="mood === v"
                [class.ring-blue-300]="mood === v"
                class="surface-elevated flex h-14 w-14 items-center justify-center rounded-full transition-all duration-200 hover:scale-105"
              >
                <i
                  class="material-icons text-5xl leading-none"
                  [ngClass]="getMoodColorClass(v) + (mood === v ? '' : ' opacity-70')"
                >
                  {{ getRatingIconFromValue(v) }}
                </i>
              </button>
            </div>
          </div>

          <!-- Grouped Events list -->
          <ng-container *ngIf="groupedEvents?.length; else emptyDay">
            <div *ngFor="let group of groupedEvents" class="">
              <div
                class="bg-neutral-50 px-6 py-2 text-xs font-semibold uppercase tracking-wide text-muted dark:bg-neutral-700/30"
              >
                {{ group.label }}
              </div>
              <div
                *ngFor="let ev of group.items"
                class="flex items-start gap-3 px-6 py-3 transition-colors hover:bg-neutral-50 dark:hover:bg-neutral-700/50"
              >
                <!-- Иконка: для практик показываем цветной смайлик рейтинга, для остальных - обычную иконку -->
                <div class="flex flex-col items-center">
                  <i
                    class="material-icons text-2xl"
                    [ngClass]="
                      ev.type === 'run' && ev.data?.rating
                        ? getMoodColorClass(ev.data.rating)
                        : 'text-secondary'
                    "
                  >
                    {{ ev.icon }}
                  </i>
                  <span
                    *ngIf="ev.type === 'run' && ev.data?.rating"
                    class="mt-1 text-xs leading-none text-muted"
                    >{{ ev.data.rating }}</span
                  >
                </div>
                <div class="min-w-0 flex-1">
                  <div class="flex items-center justify-between">
                    <div class="text-primary truncate font-medium">
                      {{ ev.title }}
                    </div>
                    <div class="text-muted text-xs">{{ ev.time | date: 'HH:mm' }}</div>
                  </div>
                  <div
                    *ngIf="ev.type === 'note'"
                    class="text-secondary line-clamp-2 text-sm"
                  >
                    {{ getPreviewText(ev.data?.content) || 'Нет содержимого' }}
                  </div>
                  <div
                    *ngIf="ev.type === 'run' && ev.data?.duration"
                    class="text-muted mt-0.5 text-xs"
                  >
                    {{ formatDuration(ev.data.duration) }}
                  </div>
                  <div
                    *ngIf="ev.type === 'note' && ev.data?.tags?.length"
                    class="mt-1 flex flex-wrap gap-1"
                  >
                    <span
                      *ngFor="let tag of ev.data.tags | slice: 0 : 3"
                      class="text-secondary dark:bg-neutral-700 inline-block rounded-full bg-neutral-100 px-2 py-0.5 text-xs"
                      >#{{ tag }}</span
                    >
                  </div>
                </div>
                <!-- Actions -->
                <div class="ml-2 flex items-center gap-1">
                  <button
                    *ngIf="ev.type === 'note'"
                    (click)="$event.stopPropagation(); toggleFavoriteNote(ev.data.id)"
                    class="rounded-full p-2 text-muted hover:bg-neutral-100 dark:hover:bg-neutral-700"
                    [title]="ev.data.isFavorite ? 'Убрать из избранного' : 'В избранное'"
                  >
                    <i class="material-icons text-base">{{
                      ev.data.isFavorite ? 'star' : 'star_border'
                    }}</i>
                  </button>
                  <button
                    *ngIf="ev.type === 'note'"
                    (click)="$event.stopPropagation(); openNote(ev.data.id)"
                    class="rounded-full p-2 text-muted hover:bg-neutral-100 dark:hover:bg-neutral-700"
                    title="Редактировать"
                  >
                    <i class="material-icons text-base">edit</i>
                  </button>
                  <button
                    *ngIf="ev.type === 'note'"
                    (click)="$event.stopPropagation(); deleteNoteById(ev.data.id)"
                    class="rounded-full p-2 text-muted hover:bg-red-50 dark:hover:bg-red-900/20"
                    title="Удалить"
                  >
                    <i class="material-icons text-base">delete</i>
                  </button>
                  <button
                    *ngIf="ev.type === 'run'"
                    (click)="$event.stopPropagation(); openPracticeRun(ev.data)"
                    class="rounded-full p-2 text-muted hover:bg-neutral-100 dark:hover:bg-neutral-700"
                    title="Открыть практику"
                  >
                    <i class="material-icons text-base">play_arrow</i>
                  </button>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-template #emptyDay>
            <div class="text-muted px-6 py-10 text-center">Нет событий за этот день</div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <app-bottom-navigation></app-bottom-navigation>
</div>
<div class="note-editor flex h-full flex-col bg-white dark:bg-gray-900">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex h-full items-center justify-center">
    <div class="flex items-center space-x-2 text-gray-500 dark:text-gray-400">
      <div class="h-8 w-8 animate-spin rounded-full border-b-2 border-blue-600"></div>
      <span>Загрузка заметки...</span>
    </div>
  </div>

  <!-- Editor -->
  <div *ngIf="!isLoading" class="flex h-full flex-col">
    <!-- Header -->
    <div
      class="editor-header sticky top-0 z-10 border-b border-gray-100 bg-white shadow-sm dark:border-gray-700 dark:bg-gray-800"
    >
      <div class="flex items-center justify-between px-4 py-3">
        <!-- Back Button and Title -->
        <div class="flex min-w-0 flex-1 items-center space-x-3">
          <button
            (click)="goBack()"
            class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 transition-colors hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600"
          >
            <i class="material-icons text-gray-500">arrow_back</i>
          </button>

          <div class="min-w-0 flex-1">
            <input
              type="text"
              [(ngModel)]="title"
              (ngModelChange)="onTitleChange()"
              placeholder="Заголовок заметки..."
              class="w-full truncate border-none bg-transparent text-lg font-semibold text-gray-700 placeholder-gray-500 outline-none dark:text-gray-200 dark:placeholder-gray-400"
            />
          </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-shrink-0 items-center space-x-1">
          <!-- Mobile Actions -->
          <div class="flex items-center space-x-1">
            <!-- Formatting Toggle -->
            <button
              (click)="toggleFormattingToolbar()"
              [class.bg-blue-100]="showFormatting"
              [class.dark:bg-blue-900]="showFormatting"
              [class.text-blue-600]="showFormatting"
              [class.dark:text-blue-400]="showFormatting"
              class="rounded-lg p-2 text-gray-500 transition-colors hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-800"
              title="Форматирование"
            >
              <i class="material-icons text-lg">format_bold</i>
            </button>

            <!-- Favorite Toggle -->
            <button
              *ngIf="!isNewNote"
              (click)="toggleFavorite()"
              [class.text-yellow-500]="note?.isFavorite"
              [class.text-gray-400]="!note?.isFavorite"
              class="rounded-lg p-2 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
              [title]="note?.isFavorite ? 'Убрать из избранного' : 'Добавить в избранное'"
            >
              <i class="material-icons text-lg">{{ note?.isFavorite ? 'star' : 'star_border' }}</i>
            </button>

            <!-- More Actions Button for Mobile -->
            <div class="relative md:hidden" *ngIf="!isNewNote">
              <button
                (click)="showMobileMenu = !showMobileMenu"
                class="rounded-lg p-2 text-gray-400 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
              >
                <i class="material-icons text-lg">more_vert</i>
              </button>

              <!-- Mobile Dropdown Menu -->
              <div
                *ngIf="showMobileMenu"
                class="absolute right-0 top-full z-20 mt-1 min-w-menu rounded-lg border border-gray-200 bg-white shadow-lg dark:border-gray-700 dark:bg-gray-800"
              >
                <button
                  (click)="deleteNote(); showMobileMenu = false"
                  class="flex w-full items-center px-4 py-3 text-left text-red-500 transition-colors hover:bg-gray-50 dark:hover:bg-gray-700"
                >
                  <i class="material-icons mr-2 text-sm">delete</i>
                  Удалить
                </button>
              </div>
            </div>

            <!-- Desktop Delete Button -->
            <button
              *ngIf="!isNewNote"
              (click)="deleteNote()"
              class="hidden rounded-lg p-2 text-gray-400 transition-colors hover:bg-red-50 hover:text-red-500 dark:hover:bg-red-900/20 md:flex"
              title="Удалить заметку"
            >
              <i class="material-icons text-lg">delete</i>
            </button>
          </div>

          <!-- Save Status -->
          <div class="ml-2 hidden items-center text-xs sm:flex">
            <span *ngIf="isSaving" class="flex items-center text-blue-600 dark:text-blue-400">
              <div class="mr-1 h-3 w-3 animate-spin rounded-full border-b-2 border-blue-600"></div>
              Сохранение...
            </span>
            <span
              *ngIf="hasUnsavedChanges && !isSaving"
              class="text-orange-600 dark:text-orange-400"
            >
              Не сохранено
            </span>
            <span
              *ngIf="!hasUnsavedChanges && !isSaving && !isNewNote"
              class="text-green-600 dark:text-green-400"
            >
              Сохранено
            </span>
          </div>
        </div>
      </div>

      <!-- Formatting Toolbar -->
      <div
        *ngIf="showFormatting"
        class="formatting-toolbar border-t border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="flex flex-wrap items-center gap-2 space-x-2">
          <!-- Lists -->
          <div
            class="flex items-center space-x-1 border-r border-gray-300 pr-2 dark:border-gray-600"
          >
            <button
              (click)="insertList()"
              class="rounded border border-gray-300 bg-white px-3 py-1 text-sm transition-colors hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600"
              title="Маркированный список"
            >
              <i class="material-icons text-sm">format_list_bulleted</i>
            </button>

            <button
              (click)="insertNumberedList()"
              class="rounded border border-gray-300 bg-white px-3 py-1 text-sm transition-colors hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600"
              title="Нумерованный список"
            >
              <i class="material-icons text-sm">format_list_numbered</i>
            </button>
          </div>

          <!-- Other -->
          <div class="flex items-center space-x-1">
            <button
              (click)="insertHashtag()"
              class="rounded border border-gray-300 bg-white px-3 py-1 text-sm transition-colors hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600"
              title="Хештег"
            >
              <span class="font-mono">#</span>
            </button>

            <button
              (click)="insertHeading()"
              class="rounded border border-gray-300 bg-white px-3 py-1 text-sm transition-colors hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:hover:bg-gray-600"
              title="Заголовок"
            >
              <i class="material-icons text-sm">title</i>
            </button>
          </div>
        </div>

        <!-- Quick Help -->
        <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
          <span class="hidden sm:inline">Горячие клавиши: </span>
          <span class="font-mono">Ctrl+L</span> - список, <span class="font-mono">Enter</span> -
          продолжить список, <span class="font-mono">#хештег</span> - теги
        </div>
      </div>
    </div>

    <!-- Editor Content -->
    <div class="editor-content flex flex-1 flex-col">
      <textarea
        [(ngModel)]="content"
        (ngModelChange)="onContentChange()"
        (keydown)="onTextareaKeydown($event)"
        placeholder="Начните писать свою заметку...

Используйте #хештеги для организации заметок по темам, например:
#сфирот #древожизни #осознания

- Создавайте списки
- Для структурирования мыслей
- Нажмите Enter для продолжения списка"
        class="w-full flex-1 resize-none border-none bg-transparent px-4 py-4 text-base leading-relaxed text-gray-900 outline-none dark:text-gray-100"
        spellcheck="false"
      >
      </textarea>
    </div>

    <!-- Footer -->
    <div
      class="editor-footer border-t border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-800"
    >
      <div class="flex items-center justify-between text-sm text-gray-500 dark:text-gray-400">
        <!-- Stats -->
        <div class="flex items-center space-x-4">
          <span>{{ getWordCount() }} слов</span>
          <span>{{ getCharCount() }} символов</span>
          <span *ngIf="getTags().length > 0">{{ getTags().length }} тегов</span>
        </div>

        <!-- Tags Preview -->
        <div *ngIf="getTags().length > 0" class="flex items-center space-x-2">
          <span class="text-xs">Теги:</span>
          <div class="flex flex-wrap gap-1">
            <span
              *ngFor="let tag of getTags() | slice: 0 : 5"
              class="rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-600 dark:bg-blue-900/30 dark:text-blue-400"
            >
              #{{ tag }}
            </span>
            <span
              *ngIf="getTags().length > 5"
              class="rounded-full bg-gray-200 px-2 py-1 text-xs text-gray-600 dark:bg-gray-700 dark:text-gray-400"
            >
              +{{ getTags().length - 5 }}
            </span>
          </div>
        </div>
      </div>

      <!-- Last Modified -->
      <div *ngIf="note && !isNewNote" class="mt-2 text-xs text-gray-400 dark:text-gray-500">
        <span *ngIf="note.createdAt === note.updatedAt">
          Создано {{ note.createdAt | date: 'dd.MM.yyyy, HH:mm' }}
        </span>
        <span *ngIf="note.createdAt !== note.updatedAt">
          Изменено {{ note.updatedAt | date: 'dd.MM.yyyy, HH:mm' }}
        </span>
      </div>
    </div>
  </div>
</div>
